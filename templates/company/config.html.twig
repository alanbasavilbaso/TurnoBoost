{% extends 'base.html.twig' %}

{% block title %}Configuración de Empresa{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/company-config.css') }}">
{% endblock %}

{% block body %}
<div class="container">
    <div class="row">

        <!-- Formulario de Configuración -->
        <div class="col-lg-12 ">
            <div class="card company-card">
                <div class="card-header-custom text-light">
                    <h5 class="card-title mb-0 fw-bold">
                        <i class="fas fa-edit text-primary me-2 text-light"></i>
                        Editar Configuración
                    </h5>
                </div>
                <div class="card-body p-4">
                    {{ form_start(form) }}
                    
                    <div class="mb-4">
                        {{ form_label(form.name, 'Nombre de la Empresa', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.name, {'attr': {'class': 'form-control form-control-lg'}}) }}
                        <small class="text-muted">El nombre que aparecerá en todos los lugares.</small>
                        {% if form.name.vars.errors|length > 0 %}
                            <div class="text-danger small mt-1">
                                {{ form_errors(form.name) }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        {{ form_label(form.description, 'Descripción', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.description, {'attr': {'class': 'form-control', 'rows': '4', 'maxlength': '255', 'id': 'description-field'}}) }}
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Contalé a tus clientes sobre tu empresa, sobre los servicios que ofreces o tu propuesta de valor.</small>
                            <small class="text-muted">
                                <span id="char-count">0</span>/255 caracteres
                            </small>
                        </div>
                        {% if form.description.vars.errors|length > 0 %}
                            <div class="text-danger small mt-1">
                                {{ form_errors(form.description) }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Configuración de WhatsApp -->
                    <h6 class="fw-bold mb-3">
                        <i class="fab fa-whatsapp me-2 text-success"></i>
                        Configuración de WhatsApp
                        <div class="field-description">
                            Configura tu número de WhatsApp para enviar notificaciones y recordatorios automáticos.
                        </div>
                    </h6>

                    <div class="config-field-group">
                        {{ form_label(form.phone, 'Teléfono para WhatsApp', {'label_attr': {'class': 'form-label'}}) }}
                        <div class="input-group">
                            <span class="input-group-text bg-success text-white">
                                <i class="fab fa-whatsapp me-1"></i>
                                +54
                            </span>
                            {{ form_widget(form.phone, {
                                'value': company.phoneWithoutPrefix,
                                'attr': {
                                    'class': 'form-control', 
                                    'id': 'whatsapp-phone',
                                    'placeholder': '11 1234 5678',
                                    'pattern': '^[0-9]{2,4}[0-9]{6,8}$',
                                    'title': 'Ingresa el número sin el +54 (ej: 11 1234 5678)'
                                }
                            }) }}
                            <button type="button" class="btn btn-primary" id="validate-whatsapp-btn" disabled>
                                <i class="fab fa-whatsapp me-1"></i>
                                Conectar
                            </button>
                        </div>
                        <small class="text-muted">
                            Número de teléfono argentino para WhatsApp (código de área + número). Ejemplo: 11 1234 5678
                        </small>
                        {% if form.phone.vars.errors|length > 0 %}
                            <div class="text-danger small mt-1">
                                {{ form_errors(form.phone) }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- WhatsApp Status Section -->
                    <div id="whatsapp-status-section" class="config-field-group" style="display: none;">
                        <div class="whatsapp-status-section">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div>
                                    <strong>Estado de Conexión:</strong>
                                    <span id="whatsapp-status" class="badge ms-2">
                                        {% if company.whatsappConnectionStatus == 'connected' %}
                                            <span class="badge bg-success">Conectado</span>
                                        {% elseif company.whatsappConnectionStatus == 'disconnected' %}
                                            <span class="badge bg-warning">Desconectado</span>
                                        {% elseif company.whatsappConnectionStatus == 'initializing' %}
                                            <span class="badge bg-info">Inicializando...</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Sin verificar</span>
                                        {% endif %}
                                    </span>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="verify-whatsapp-btn">
                                    <i class="fas fa-sync-alt me-1"></i>
                                    Verificar Estado
                                </button>
                            </div>

                            <div id="whatsapp-last-checked" style="display: none;">
                                <small class="text-muted">
                                    Última verificación: <span id="last-checked-time">{{ company.whatsappLastChecked ? company.whatsappLastChecked|date('d/m/Y H:i') : 'Nunca' }}</span>
                                </small>
                            </div>

                            <!-- QR Code Section -->
                            <div id="whatsapp-qr-section" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <h6><i class="fab fa-whatsapp me-2"></i>Conectar WhatsApp</h6>
                                    <p class="mb-2">Escanea el código QR con tu teléfono para conectar WhatsApp:</p>
                                    <div class="text-center">
                                        <div id="qr-code-container" class="mb-3">
                                            <!-- QR code will be inserted here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Connection Success -->
                            <div id="whatsapp-success-section" class="mt-3" style="display: none;">
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-check-circle me-2"></i>¡WhatsApp Conectado!</h6>
                                    <p class="mb-0">Tu número de WhatsApp está conectado y listo para enviar notificaciones.</p>
                                </div>
                            </div>

                            <!-- Error Section -->
                            <div id="whatsapp-error-section" class="mt-3" style="display: none;">
                                <div class="alert alert-danger">
                                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Error de Conexión</h6>
                                    <p class="mb-0" id="whatsapp-error-message">Ha ocurrido un error al conectar WhatsApp.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    
                    <!-- Sección de Imágenes -->
                    <div class="mb-4">
                        <h6 class="form-section-title">
                            <i class="fas fa-images me-2"></i>
                            Imágenes de la Empresa
                        </h6>
                        
                        <div class="row">
                            <!-- Logo -->
                            <div class="col-md-6">
                                <div class="image-upload-section">
                                    {{ form_label(form.logoFile, 'Logo de la Empresa', {'label_attr': {'class': 'form-label'}}) }}
                                    
                                    {% if company.logoUrl %}
                                        <div class="current-image-preview mb-2">
                                            <img src="{{ company.logoUrl }}" alt="Logo actual" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                            <small class="text-muted d-block">Logo actual</small>
                                        </div>
                                    {% endif %}
                                    
                                    {{ form_widget(form.logoFile, {'attr': {'class': 'form-control', 'accept': 'image/*'}}) }}
                                    {{ form_help(form.logoFile) }}
                                    
                                    {% if form.logoFile.vars.errors|length > 0 %}
                                        <div class="text-danger small mt-1">
                                            {{ form_errors(form.logoFile) }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Portada -->
                            <div class="col-md-6">
                                <div class="image-upload-section">
                                    {{ form_label(form.coverFile, 'Imagen de Portada', {'label_attr': {'class': 'form-label'}}) }}
                                    
                                    {% if company.coverUrl %}
                                        <div class="current-image-preview mb-2">
                                            <img src="{{ company.coverUrl }}" alt="Portada actual" class="img-thumbnail" style="max-width: 200px; max-height: 120px;">
                                            <small class="text-muted d-block">Portada actual</small>
                                        </div>
                                    {% endif %}
                                    
                                    {{ form_widget(form.coverFile, {'attr': {'class': 'form-control', 'accept': 'image/*'}}) }}
                                    {{ form_help(form.coverFile) }}
                                    
                                    {% if form.coverFile.vars.errors|length > 0 %}
                                        <div class="text-danger small mt-1">
                                            {{ form_errors(form.coverFile) }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        {{ form_label(form.domain, 'Dominio para Reservas', {'label_attr': {'class': 'form-label'}}) }}
                        <i class="fas fa-info-circle info-icon ms-1" 
                           data-bs-toggle="tooltip" 
                           title="Este dominio se usará para crear la URL de reservas online"></i>
                        {{ form_widget(form.domain, {'attr': {'class': 'form-control', 'id': 'domain-input'}}) }}
                        <small class="text-muted">Dirección de tu sitio web de agendamiento<br>Destaca tu marca personalizando la dirección de tu sitio web</small>
                        {% if form.domain.vars.errors|length > 0 %}
                            <div class="text-danger small mt-1">
                                {{ form_errors(form.domain) }}
                            </div>
                        {% endif %}
                        <div class="domain-preview">
                            <strong><i class="fas fa-globe me-2"></i>Preview:</strong> 
                            <span class="text-primary fw-bold" id="domain-preview">
                                {{ app.request.schemeAndHttpHost }}/{{ company.domain }}
                            </span>
                        </div>
                    </div>

                    <div class="mb-4">
                        {{ form_label(form.primaryColor, 'Color Principal del Sitio Web', {'label_attr': {'class': 'form-label'}}) }}
                        <div class="color-input-group">
                            <div class="input-group">
                                {{ form_widget(form.primaryColor, {'attr': {'class': 'form-control form-control-color', 'id': 'primary-color-input'}}) }}
                                <input type="text" class="form-control" id="color-hex-input" placeholder="#1a1a1a" readonly>
                            </div>
                        </div>
                        <small class="text-muted">
                            Te sugerimos que utilices el color que usas para las comunicaciones de tu negocio, como redes sociales y web. Recomendamos que uses colores oscuros para tener mejor legibilidad.
                        </small>
                        {% if form.primaryColor.vars.errors|length > 0 %}
                            <div class="text-danger small mt-1">
                                {{ form_errors(form.primaryColor) }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Acordeón de Notificaciones y Recordatorios -->
                    <div class="accordion mb-3" id="notificationAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="notificationHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#notificationCollapse" aria-expanded="false" aria-controls="notificationCollapse">
                                    <div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-bell me-2"></i>
                                            Notificaciones y Recordatorios
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            Configura las notificaciones automáticas por Email y WhatsApp
                                        </small>
                                    </div>
                                </button>
                            </h2>
                            <div id="notificationCollapse" class="accordion-collapse collapse" aria-labelledby="notificationHeading" data-bs-parent="#notificationAccordion">
                                <div class="accordion-body">
                                    <!-- Notificaciones de Email -->
                                    <h6 class="fw-bold mb-3">
                                        <i class="fas fa-bell me-2"></i>
                                        Notificaciones  de creación, edición o cancelación de turno
                                        <div class="field-description">Permite que tus clientes reciban un email de creación, modificación o eliminación de cita. El email será enviado justo después realizar la acción. En caso de creación de cita esta puede ser creada por tus clientes desde el sitio web o internamente desde la Agenda.</div>
                                    </h6>

                                    <div class="config-field-group">
                                        <div class="form-check form-switch">
                                            {{ form_widget(form.emailNotificationsEnabled, {
                                                'attr': {
                                                    'class': 'form-check-input',
                                                    'role': 'switch'
                                                }
                                            }) }}
                                            {{ form_label(form.emailNotificationsEnabled, 'Enviar Notificaciones por Email', {
                                                'label_attr': {'class': 'form-check-label fw-bold'}
                                            }) }}
                                        </div>
                                    </div>

                                    <div class="config-field-group">
                                        <div class="form-check form-switch">
                                            {{ form_widget(form.whatsappNotificationsEnabled, {
                                                'attr': {
                                                    'class': 'form-check-input',
                                                    'role': 'switch'
                                                }
                                            }) }}
                                            {{ form_label(form.whatsappNotificationsEnabled, 'Enviar Notificaciones por WhatsApp', {
                                                'label_attr': {'class': 'form-check-label fw-bold'}
                                            }) }}
                                        </div>
                                    </div>

                                    <hr class="my-3">

                                    <!-- Recordatorios -->
                                    <h6 class="fw-bold mb-3">
                                        <i class="fas fa-clock me-2"></i>
                                        Recordatorios Automáticos
                                        <div class="field-description">
                                            Envía recordatorios por WhatsApp antes del turno programadas.
                                        </div>
                                    </h6>

                                    <div class="config-field-group">
                                        <div class="form-check form-switch">
                                            {{ form_widget(form.reminderEmailEnabled, {
                                                'attr': {
                                                    'class': 'form-check-input',
                                                    'role': 'switch'
                                                }
                                            }) }}
                                            {{ form_label(form.reminderEmailEnabled, 'Recordatorios por Email', {
                                                'label_attr': {'class': 'form-check-label fw-bold'}
                                            }) }}
                                        </div>
                                    </div>

                                    <div class="config-field-group">
                                        <div class="form-check form-switch">
                                            {{ form_widget(form.reminderWhatsappEnabled, {
                                                'attr': {
                                                    'class': 'form-check-input',
                                                    'role': 'switch'
                                                }
                                            }) }}
                                            {{ form_label(form.reminderWhatsappEnabled, 'Recordatorios por WhatsApp', {
                                                'label_attr': {'class': 'form-check-label fw-bold'}
                                            }) }}
                                        </div>
                                    </div>

                                    <div class="config-field-group">
                                        {{ form_label(form.firstReminderHoursBeforeAppointment, 'Primer Recordatorio (horas antes)', {'label_attr': {'class': 'form-label'}}) }}
                                        <div class="time-input-group">
                                            <div class="input-group">
                                                {{ form_widget(form.firstReminderHoursBeforeAppointment, {
                                                    'attr': {
                                                        'class': 'form-control',
                                                        'min': '1',
                                                        'max': '168',
                                                        'step': '1',
                                                        'placeholder': '24'
                                                    }
                                                }) }}
                                                <span class="input-group-text">Horas</span>
                                            </div>
                                        </div>
                                        <div class="field-description">
                                            Define cuántas horas antes de la reserva se enviará el primer recordatorio.
                                        </div>
                                        {% if form.firstReminderHoursBeforeAppointment.vars.errors|length > 0 %}
                                            <div class="text-danger small mt-1">
                                                {{ form_errors(form.firstReminderHoursBeforeAppointment) }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <hr class="my-3">

                                    <!-- Segundo Recordatorio -->
                                    <h6 class="fw-bold mb-3">
                                        <i class="fas fa-bell me-2"></i>
                                        Segundo Recordatorio (Urgente)
                                        <div class="field-description">
                                            Envía un segundo recordatorio más cercano al turno.
                                        </div>
                                    </h6>

                                    <div class="config-field-group">
                                        <div class="form-check form-switch">
                                            {{ form_widget(form.secondReminderEnabled, {
                                                'attr': {
                                                    'class': 'form-check-input',
                                                    'role': 'switch'
                                                }
                                            }) }}
                                            {{ form_label(form.secondReminderEnabled, 'Habilitar Segundo Recordatorio', {
                                                'label_attr': {'class': 'form-check-label fw-bold'}
                                            }) }}
                                        </div>
                                    </div>

                                    <div class="config-field-group">
                                        {{ form_label(form.secondReminderHoursBeforeAppointment, 'Segundo Recordatorio (horas antes)', {'label_attr': {'class': 'form-label'}}) }}
                                        <div class="time-input-group">
                                            <div class="input-group">
                                                {{ form_widget(form.secondReminderHoursBeforeAppointment, {
                                                    'attr': {
                                                        'class': 'form-control',
                                                        'min': '1',
                                                        'max': '48',
                                                        'step': '1',
                                                        'placeholder': '2'
                                                    }
                                                }) }}
                                                <span class="input-group-text">Horas</span>
                                            </div>
                                        </div>
                                        <div class="field-description">
                                            Define cuántas horas antes de la reserva se enviará el segundo recordatorio.
                                        </div>
                                        {% if form.secondReminderHoursBeforeAppointment.vars.errors|length > 0 %}
                                            <div class="text-danger small mt-1">
                                                {{ form_errors(form.secondReminderHoursBeforeAppointment) }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuración de Reservas -->
                    <div class="accordion mb-3" id="bookingConfigAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="bookingConfigHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#bookingConfigCollapse" aria-expanded="false" aria-controls="bookingConfigCollapse">
                                    <div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-calendar-alt me-2"></i>
                                            Configuración de Reservas
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            Configura cómo funcionan las reservas en tu sitio web y los tiempos permitidos.
                                        </small>
                                    </div>
                                </button>
                            </h2>
                            <div id="bookingConfigCollapse" class="accordion-collapse collapse" aria-labelledby="bookingConfigHeading" data-bs-parent="#bookingConfigAccordion">
                                <div class="accordion-body">
                                    <!-- Habilitar Reservas Online -->
                                    <div class="config-field-group">
                                        <div class="form-check form-switch">
                                            {{ form_widget(form.onlineBookingEnabled, {
                                                'attr': {
                                                    'class': 'form-check-input',
                                                    'role': 'switch'
                                                }
                                            }) }}
                                            {{ form_label(form.onlineBookingEnabled, 'Habilitar Reservas en Línea', {
                                                'label_attr': {'class': 'form-check-label fw-bold'}
                                            }) }}
                                        </div>
                                        <div class="field-description">
                                            Habilita esta opción para que tus clientes puedan reservar por internet en tu sitio web.
                                        </div>
                                    </div>

                                    <hr class="my-3">

                                    <!-- Tiempos de Reserva -->
                                    <h6 class="fw-bold mb-3">
                                        <i class="fas fa-clock me-2"></i>
                                        Tiempos de Reserva
                                    </h6>

                                    <div class="config-field-group">
                                        {{ form_label(form.minimumBookingTime, 'Tiempo Mínimo de Reserva', {'label_attr': {'class': 'form-label'}}) }}
                                        <div class="time-input-group">
                                            <div class="input-group">
                                                {{ form_widget(form.minimumBookingTime, {
                                                    'attr': {
                                                        'class': 'form-control',
                                                        'min': '0',
                                                        'step': '1',
                                                        'placeholder': '60'
                                                    }
                                                }) }}
                                                <span class="input-group-text">Minutos</span>
                                            </div>
                                        </div>
                                        <div class="field-description">
                                            Minutos mínimos requeridas para que un cliente reserve. No se podrá reservar con menos anticipación.
                                        </div>
                                        {% if form.minimumBookingTime.vars.errors|length > 0 %}
                                            <div class="text-danger small mt-1">
                                                {{ form_errors(form.minimumBookingTime) }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="config-field-group">
                                        {{ form_label(form.maximumFutureTime, 'Tiempo Máximo de Reserva', {'label_attr': {'class': 'form-label'}}) }}
                                        <div class="time-input-group">
                                            <div class="input-group">
                                                {{ form_widget(form.maximumFutureTime, {
                                                    'attr': {
                                                        'class': 'form-control',
                                                        'min': '1',
                                                        'max': '365',
                                                        'step': '1',
                                                        'placeholder': '90'
                                                    }
                                                }) }}
                                                <span class="input-group-text">Días</span>
                                            </div>
                                        </div>
                                        <div class="field-description">
                                            Tiempo máximo que una persona puede reservar a futuro. No se permiten citas para más de 13 meses a futuro.
                                        </div>
                                        {% if form.maximumFutureTime.vars.errors|length > 0 %}
                                            <div class="text-danger small mt-1">
                                                {{ form_errors(form.maximumFutureTime) }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Políticas de Cancelación y Edición -->
                    <div class="accordion mb-3" id="cancellationPolicyAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="cancellationPolicyHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cancellationPolicyCollapse" aria-expanded="false" aria-controls="cancellationPolicyCollapse">
                                    <div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-edit me-2"></i>
                                            Políticas de Cancelación y Edición
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            Define las reglas para cancelar y modificar citas, incluyendo tiempos límite y restricciones.
                                        </small>
                                    </div>
                                </button>
                            </h2>
                            <div id="cancellationPolicyCollapse" class="accordion-collapse collapse" aria-labelledby="cancellationPolicyHeading" data-bs-parent="#cancellationPolicyAccordion">
                                <div class="accordion-body">
                                    <!-- Switches de Políticas -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="config-field-group">
                                                <div class="form-check form-switch">
                                                    {{ form_widget(form.cancellableBookings, {
                                                        'attr': {
                                                            'class': 'form-check-input',
                                                            'role': 'switch'
                                                        }
                                                    }) }}
                                                    {{ form_label(form.cancellableBookings, 'Reservas Cancelables', {
                                                        'label_attr': {'class': 'form-check-label fw-bold'}
                                                    }) }}
                                                </div>
                                                <div class="field-description">
                                                    Permite que los clientes cancelen sus reservas
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="config-field-group">
                                                <div class="form-check form-switch">
                                                    {{ form_widget(form.editableBookings, {
                                                        'attr': {
                                                            'class': 'form-check-input',
                                                            'role': 'switch'
                                                        }
                                                    }) }}
                                                    {{ form_label(form.editableBookings, 'Reservas Editables', {
                                                        'label_attr': {'class': 'form-check-label fw-bold'}
                                                    }) }}
                                                </div>
                                                <div class="field-description">
                                                    Permite que los clientes editen sus reservas
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <hr class="my-3">

                                    <!-- Configuraciones de Tiempo y Límites -->
                                    <h6 class="fw-bold mb-3">
                                        <i class="fas fa-clock me-2"></i>
                                        Restricciones de Tiempo y Límites
                                    </h6>

                                    <div class="config-field-group">
                                        {{ form_label(form.minimumEditTime, 'Tiempo Mínimo para Editar/Cancelar', {'label_attr': {'class': 'form-label'}}) }}
                                        <div class="time-input-group">
                                            <div class="input-group">
                                                {{ form_widget(form.minimumEditTime, {
                                                    'attr': {
                                                        'class': 'form-control',
                                                        'min': '0',
                                                        'step': '1',
                                                        'placeholder': '120'
                                                    }
                                                }) }}
                                                <span class="input-group-text">Minutos</span>
                                            </div>
                                        </div>
                                        <div class="field-description">
                                            Minutos mínimos requeridos para que un cliente edite o cancele su cita. No se podrá editar o cancelar citas con menos anticipación.
                                        </div>
                                        {% if form.minimumEditTime.vars.errors|length > 0 %}
                                            <div class="text-danger small mt-1">
                                                {{ form_errors(form.minimumEditTime) }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="config-field-group">
                                        {{ form_label(form.maximumEdits, 'Máximo de Ediciones Permitidas', {'label_attr': {'class': 'form-label'}}) }}
                                        <div class="input-group">
                                            {{ form_widget(form.maximumEdits, {
                                                'attr': {
                                                    'class': 'form-control',
                                                    'min': '0',
                                                    'max': '10',
                                                    'step': '1',
                                                    'placeholder': '3'
                                                }
                                            }) }}
                                            <span class="input-group-text">Ediciones</span>
                                        </div>
                                        <div class="field-description">
                                            Cantidad máxima de veces que puede editar su cita.
                                        </div>
                                        {% if form.maximumEdits.vars.errors|length > 0 %}
                                            <div class="text-danger small mt-1">
                                                {{ form_errors(form.maximumEdits) }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- Comportamiento de Reservas -->
                    <div class="accordion mb-3" id="bookingBehaviorAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="bookingBehaviorHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#bookingBehaviorCollapse" aria-expanded="false" aria-controls="bookingBehaviorCollapse">
                                    <div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-cogs me-2"></i>
                                            Comportamiento de Reservas
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            Configura la visualización de tu agenda y el comportamiento de tus reservas creadas.
                                        </small>
                                    </div>
                                </button>
                            </h2>
                            <div id="bookingBehaviorCollapse" class="accordion-collapse collapse" aria-labelledby="bookingBehaviorHeading" data-bs-parent="#bookingBehaviorAccordion">
                                <div class="accordion-body">
                                    <div class="config-field-group">
                                        <div class="form-check form-switch">
                                            {{ form_widget(form.requireContactData, {
                                                'attr': {
                                                    'class': 'form-check-input',
                                                    'role': 'switch'
                                                }
                                            }) }}
                                            {{ form_label(form.requireContactData, 'Requerir Datos de Contacto', {
                                                'label_attr': {'class': 'form-check-label fw-bold'}
                                            }) }}
                                        </div>
                                        <div class="field-description">
                                            Si habilitas esta opción, al generar una nueva reserva desde la agenda, el cliente debe tener asociado como mínimo email o teléfono.
                                        </div>
                                        {% if form.requireContactData.vars.errors|length > 0 %}
                                            <div class="text-danger small mt-1">
                                                {{ form_errors(form.requireContactData) }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Limitar Cantidad de Citas -->
                    <div class="accordion mb-3" id="bookingLimitsAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="bookingLimitsHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#bookingLimitsCollapse" aria-expanded="false" aria-controls="bookingLimitsCollapse">
                                    <div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-limit me-2"></i>
                                            Limitar Cantidad de Citas que Puede Agendar un Cliente
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            En este bloque puedes configurar límites para que tus clientes agenden de acuerdo a la frecuencia que necesites.
                                        </small>
                                    </div>
                                </button>
                            </h2>
                            <div id="bookingLimitsCollapse" class="accordion-collapse collapse" aria-labelledby="bookingLimitsHeading" data-bs-parent="#bookingLimitsAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="config-field-group">
                                                {{ form_label(form.bookingLimitLevel, 'Limitar por', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                                {{ form_widget(form.bookingLimitLevel, {
                                                    'attr': {
                                                        'class': 'form-select'
                                                    }
                                                }) }}
                                                <div class="field-description">
                                                    Selecciona el nivel donde aplicar el límite de citas pendientes
                                                </div>
                                                {% if form.bookingLimitLevel.vars.errors|length > 0 %}
                                                    <div class="text-danger small mt-1">
                                                        {{ form_errors(form.bookingLimitLevel) }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="config-field-group">
                                                {{ form_label(form.maxPendingBookings, 'Cantidad de Turnos Permitidos', {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                                <div class="input-group">
                                                    {{ form_widget(form.maxPendingBookings, {
                                                        'attr': {
                                                            'class': 'form-control',
                                                            'min': '1',
                                                            'max': '50',
                                                            'step': '1',
                                                            'placeholder': '5'
                                                        }
                                                    }) }}
                                                    <span class="input-group-text">Turnos</span>
                                                </div>
                                                <div class="field-description">
                                                    Número máximo de turnos pendientes o a futuro que puede tener un cliente
                                                </div>
                                                {% if form.maxPendingBookings.vars.errors|length > 0 %}
                                                    <div class="text-danger small mt-1">
                                                        {{ form_errors(form.maxPendingBookings) }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="alert alert-info mt-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Ejemplo:</strong> Si configuras "Por Empresa" con "3 turnos", un cliente no podrá agendar más de 3 citas pendientes en toda la empresa. Si configuras "Por Profesional" con "2 turnos", el cliente podrá tener máximo 2 citas pendientes con cada profesional.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pagos en Línea -->
                    <div class="accordion mb-3" id="onlinePaymentsAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="onlinePaymentsHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#onlinePaymentsCollapse" aria-expanded="false" aria-controls="onlinePaymentsCollapse">
                                    <div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-credit-card me-2"></i>
                                            Pagos en Línea
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            Configura la integración con Mercado Pago para recibir pagos en línea.
                                        </small>
                                    </div>
                                </button>
                            </h2>
                            <div id="onlinePaymentsCollapse" class="accordion-collapse collapse" aria-labelledby="onlinePaymentsHeading" data-bs-parent="#onlinePaymentsAccordion">
                                <div class="accordion-body">
                                    <div class="config-field-group">
                                        <div class="form-check form-switch">
                                            {{ form_widget(form.onlinePaymentsEnabled, {
                                                'attr': {
                                                    'class': 'form-check-input',
                                                    'role': 'switch'
                                                }
                                            }) }}
                                            {{ form_label(form.onlinePaymentsEnabled, 'Habilitar Pagos en Línea', {
                                                'label_attr': {'class': 'form-check-label fw-bold'}
                                            }) }}
                                        </div>
                                        <div class="field-description">
                                            Habilita los pagos en línea a través de Mercado Pago para que tus clientes puedan pagar sus servicios al momento de reservar.
                                        </div>
                                        {% if form.onlinePaymentsEnabled.vars.errors|length > 0 %}
                                            <div class="text-danger small mt-1">
                                                {{ form_errors(form.onlinePaymentsEnabled) }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="alert alert-warning mt-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Próximamente:</strong> La integración con Mercado Pago estará disponible en una próxima actualización. Por ahora puedes habilitar esta opción para preparar tu configuración.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                        <a href="{{ path('app_index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Dashboard
                        </a>
                        {{ form_widget(form.submit, {'attr': {'class': 'btn btn-primary'}}) }}
                    </div>

                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('scripts/company-config.js') }}"></script>
{% endblock %}
